---
# tasks file for setup_exchange
- name: Install .NET Framework 4.7.2
  win_package:
    path: https://go.microsoft.com/fwlink/?linkid=863265
    arguments:
      - /q
      - /norestart

- name: Install Visual C++
  win_package:
    path: https://www.microsoft.com/en-us/download/confirmation.aspx?id=40784
    arguments:
      - /q
      - /norestart

- name: Install UCMA
  win_package:
    path: https://www.microsoft.com/en-us/download/confirmation.aspx?id=34992
    arguments:
      - /q
      - /norestart

- name: Install mandatory windows features
  win_feature:
    name: "{{ features }}"

- name: Download Exchange iso
  win_get_url:
    url: https://www.microsoft.com/en-us/download/confirmation.aspx?id=103478
    dest: C:\exchange.iso

- name: mount iso
  win_disk_image:
    image_path: C:\exchange.iso
    state: present
  register: disk_image_out

- name: Prepare AD
  win_package:
    path: '{{ disk_image_out[0] }}\Setup.exe'
    arguments:
      - /IAcceptExchangeServerLicenseTerms
      - /PrepareAD

- name: Prepare Schema
  win_package:
    path: '{{ disk_image_out[0] }}\Setup.exe'
    arguments:
      - /IAcceptExchangeServerLicenseTerms
      - /PrepareSchema

- name: Install exchange server
  win_package:
    path: '{{ disk_image_out[0] }}\Setup.exe'
    arguments:
      - /IAcceptExchangeServerLicenseTerms
      - /Mode:Install
      - /Roles:MB

- name: Finally reboot
  win_reboot: